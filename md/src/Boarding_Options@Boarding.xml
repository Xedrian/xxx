<?xml version="1.0" encoding="iso-8859-1" ?>
<diff>
	<add sel="//cue[@name='Start']/actions/start_conversation" pos="before">
		<set_value name="$startoption" exact="'undecided'"/>
		<set_value name="$destroyoption" exact="'undecided'"/>
		<set_value name="$hackoption" exact="'undecided'"/>
		<set_value name="$checkresistance" exact="true"/>
		<set_value name="$checkpreboardstrength" exact="true"/>
		<set_value name="$checkattackstrength" exact="false"/>
		<set_value name="$preboardstrength" exact="0.0f"/>
		<create_list name="$PreboardUnits" exact="unitcategory.marine.maxmk"/>
	</add>

	<add sel="//cue[@name='BoardingSupport_Started_Conversation']/actions">
		<add_player_choice text="'Disable Engines/Jumpdrive'" position="top_left" section="BoardingSupport_Started_Conversation_disableship"/>
		<add_player_choice text="'Disable Weapons'" position="top_right" section="BoardingSupport_Started_Conversation_disarmship"/>
		<add_player_choice text="'Launch Pods'" position="left" section="BoardingSupport_Started_Conversation_launchpods"/>
		<add_player_choice text="'Abort'" position="bottom_left" section="BoardingSupport_Started_Conversation_abort"/>
		<allow_conversation_escape enabled="false"/>
	</add>

	<add sel="//cue[@name='BoardingSupport_DestroyEngine_Started_Conversation']" pos="after">
		<cue name="BoardingSupport_DestroyWeapons_Started_Conversation" instantiate="true">
			<conditions>
				<event_conversation_started conversation="BoardingSupport_DestroyWeapons_Started_Conversation"/>
			</conditions>
			<actions>
				<do_any>
					<add_npc_line speaker="player.copilot" line="10642" comment="Hang on, let me mark some suitable targets."/>
					<add_npc_line speaker="player.copilot" line="10643" comment="There. Just start shooting these."/>
				</do_any>
			</actions>
		</cue>
		<cue name="BoardingSupport_TargetTooFast_Conversation" instantiate="true">
			<conditions>
				<event_conversation_started conversation="BoardingSupport_TargetTooFast_Conversation"/>
			</conditions>
			<actions>
				<add_player_choice text="'Disable Engines'" position="top_left" section="BoardingSupport_TargetTooFast_Conversation_disableengines"/>
				<add_player_choice text="'Attempt Boarding'" position="left" section="BoardingSupport_TargetTooFast_Conversation_attemptlaunchpods"/>
				<add_player_choice text="'Abort'" position="bottom_left" section="BoardingSupport_TargetTooFast_Conversation_abort"/>
				<allow_conversation_escape enabled="false"/>
			</actions>
		</cue>
		<cue name="BoardingSupport_Destroy_Options_Conversation" instantiate="true">
			<conditions>
				<event_conversation_started conversation="BoardingSupport_Destroy_Options_Conversation"/>
			</conditions>
			<actions>
				<add_player_choice text="'Normal Support'" position="top_left" section="BoardingSupport_Destroy_Options_Conversation_normalsupport"/>
				<add_player_choice text="'Target Weapons Only'" position="top_right" section="BoardingSupport_Destroy_Options_Conversation_weaponsonly"/>
				<do_all exact="player.primaryship.drones.count" counter="$i">
					<do_if value="player.primaryship.drones.{$i}.hackerprobe">
						<add_player_choice text="'Use Hacking Only'" position="left" section="BoardingSupport_Destroy_Options_Conversation_hackingonly"/>
					</do_if>
				</do_all>
			</actions>
		</cue>
	</add>

	<add sel="//cue[@name='CheckTargetState']" pos="before">
		<cue name="BoardingSupport_Started_Options" instantiate="true">
			<conditions>
				<event_conversation_next_section sectionprefix="BoardingSupport_Started_Conversation_"/>
			</conditions>
			<actions>
				<do_if value="event.param == 'BoardingSupport_Started_Conversation_disableship'">
					<set_value name="$startoption" exact="'disableship'"/>
					<reset_cue cue="CheckTargetState"/>
				</do_if>
				<do_elseif value="event.param == 'BoardingSupport_Started_Conversation_disarmship'">
					<set_value name="$startoption" exact="'disarmship'"/>
					<reset_cue cue="CheckTargetState"/>
				</do_elseif>
				<do_elseif value="event.param == 'BoardingSupport_Started_Conversation_launchpods'">
					<set_value name="$startoption" exact="'launchpods'"/>
					<reset_cue cue="CheckTargetState"/>
				</do_elseif>
				<do_elseif value="event.param == 'BoardingSupport_Started_Conversation_abort'">
					<include_actions ref="ClearOnFail"/>
					<remove_mission cue="Start"/>
					<cancel_cue cue="Start"/>
				</do_elseif>
			</actions>
		</cue>
		<cue name="BoardingSupport_TargetTooFast_Options" instantiate="true">
			<conditions>
				<event_conversation_next_section sectionprefix="BoardingSupport_TargetTooFast_Conversation_"/>
			</conditions>
			<actions>
				<do_if value="event.param == 'BoardingSupport_TargetTooFast_Conversation_disableengines'">
					<set_value name="$startoption" exact="'disableengines'"/>
				</do_if>
				<do_elseif value="event.param == 'BoardingSupport_TargetTooFast_Conversation_attemptlaunchpods'">
					<set_value name="$startoption" exact="'attemptlaunchpods'"/>
				</do_elseif>
				<do_elseif value="event.param == 'BoardingSupport_TargetTooFast_Conversation_abort'">
					<include_actions ref="ClearOnFail"/>
					<remove_mission cue="Start"/>
					<cancel_cue cue="Start"/>
				</do_elseif>
			</actions>
		</cue>
		<cue name="WaitForStartOption">
			<actions>
				<complete_cue cue="CheckTargetState"/>
			</actions>
		</cue>
		<cue name="CheckResistance" instantiate="true" checkinterval="1s">
			<conditions>
				<check_value value="$checkresistance"/>
			</conditions>
			<actions>
				<remove_help all="true"/>
				<do_if value="$checkattackstrength">
					<show_help position="12" duration="5s" custom="'Target Resistance: %1\nMarine Strength: %2'.[$target.boardingresistance, $attackstrength]" silent="true"/>
				</do_if>
				<do_else>
					<do_if value="$checkpreboardstrength">
						<do_all exact="unitcategory.marine.maxmk" counter="$i">
							<set_value name="$PreboardUnits.{$i}" exact="$boardership.availableunits.{unitcategory.marine}.mk.{$i}.list"/>
						</do_all>
						<set_value name="$preboardstrength" exact="0.0f"/>
						<set_value name="$preboardstrength" operation="add" exact="$PreboardUnits.{1}.count * param.boarding.recruitstrength"/>
						<set_value name="$preboardstrength" operation="add" exact="$PreboardUnits.{2}.count * param.boarding.veteranstrength"/>
						<set_value name="$preboardstrength" operation="add" exact="$PreboardUnits.{3}.count * param.boarding.elitestrength"/>
						<do_if value="$commander">
							<set_value name="$preboardstrength" exact="($preboardstrength * ($commander.combinedskill + 1)) / 100"/>
						</do_if>
					</do_if>
					<show_help position="12" duration="5s" custom="'Target Resistance: %1\nMarine Strength: %2'.[$target.boardingresistance, $preboardstrength]" silent="true"/>
				</do_else>
			</actions>
		</cue>
		<cue name="ResetCheckResistance" instantiate="true">
			<conditions>
				<event_cue_signalled/>
			</conditions>
			<delay exact="5s"/>
			<actions>
				<set_value name="$checkresistance" exact="true"/>
			</actions>
		</cue>
	</add>

	<add sel="//cue[@name='CheckTargetState']/actions/find_object_component[@groupname='$engines']" pos="after">
		<find_object_component groupname="$weapons" object="$target" class="class.weapon" surfaceelement="true" multiple="true" integrated="false"/>
	</add>

	<replace sel="//cue[@name='CheckTargetState']/actions/do_if[@value='$jumpdrives.count']">
		<do_if value="$jumpdrives.count and $startoption == 'disableship'">
			<signal_cue cue="DisableJumpdrive"/>
		</do_if>
	</replace>
	<replace sel="//cue[@name='CheckTargetState']/actions/do_elseif[@value='$engines.count']">
		<do_elseif value="$engines.count and $startoption == 'disableship'">
			<signal_cue cue="DisableEngines"/>
		</do_elseif>
	</replace>
	<add sel="//cue[@name='CheckTargetState']/actions/do_elseif[@value='$target.speed gt 50']" pos="before">
		<do_elseif value="$weapons.count and $startoption == 'disarmship'">
			<signal_cue cue="DisableWeapons"/>
		</do_elseif>
		<do_elseif value="$engines.count and $startoption == 'disableengines'">
			<signal_cue cue="DisableEngines"/>
		</do_elseif>
	</add>
	<replace sel="//cue[@name='CheckTargetState']/actions/do_elseif[@value='$target.speed gt 50']">
		<do_elseif value="$target.speed gt 50 and $startoption != 'attemptlaunchpods'">
			<do_if value="$startoption == 'launchpods' or $startoption == 'disarmship'">
				<set_value name="$startoption" exact="'undecided'"/>
				<set_value name="$checkresistance" exact="false"/>
				<signal_cue cue="ResetCheckResistance"/>
				<remove_help all="true"/>
				<show_help custom="'Target moving too fast!'" position="0"/>
				<start_conversation actor="player.copilot" conversation="BoardingSupport_TargetTooFast_Conversation"/>
			</do_if>
			<signal_cue cue="WaitForLaunch"/>
		</do_elseif>
	</replace>
	<add sel="//cue[@name='CheckTargetState']/actions/do_else/cancel_cue[@cue='this']" pos="before">
		<cancel_conversation actor="player.copilot" conversation="BoardingSupport_TargetTooFast_Conversation"/>
	</add>

	<add sel="//cue[@name='DisableEngines']" pos="after">
		<cue name="DisableWeapons" instantiate="true">
			<conditions>
				<event_cue_signalled/>
			</conditions>
			<delay min="1s" max="2s"/>
			<actions>
				<start_conversation actor="player.copilot" conversation="BoardingSupport_DestroyWeapons_Started_Conversation"/>
			</actions>
			<cues>
				<cue name="StartDestroyWeapons">
					<conditions>
						<event_cue_completed cue="parent"/>
					</conditions>
					<cues>
						<cue name="DestroyWeapons" ref="md.RML_Destroy_Components.DestroyComponents">
							<param name="EndSignalCue" value="CheckTargetState"/>
							<param name="MissionCue" value="Start"/>
							<param name="Targets_Param" value="$weapons"/>
							<param name="DebugChance" value="$debugoutputchance"/>
						</cue>
					</cues>
				</cue>
			</cues>
		</cue>
	</add>

	<add sel="//cue[@name='LaunchBoardingPods']/actions" pos="prepend">
		<set_value name="$checkpreboardstrength" exact="false"/>
	</add>

	<add sel="//cue[@name='BoardingSupport_Hack_Started_Conversation']/actions/show_help" pos="before">
		<add_player_choice text="'Start/Continue Hacking'" position="top_left" section="BoardingSupport_Hack_Started_Conversation_yes"/>
		<add_player_choice text="'Find A New Target'" position="left" section="BoardingSupport_Hack_Started_Conversation_no"/>
		<add_player_choice text="'Disable Hacking'" position="bottom_left" section="BoardingSupport_Hack_Started_Conversation_never"/>
	</add>

	<add sel="//cue[@name='BoardingCycle']/cues" pos="prepend">
		<cue name="BoardingSupport_Hack_Options" instantiate="true">
			<conditions>
				<event_conversation_next_section sectionprefix="BoardingSupport_Hack_Started_Conversation_"/>
			</conditions>
			<actions>
				<do_if value="event.param == 'BoardingSupport_Hack_Started_Conversation_yes'">
					<set_value name="$hackoption" exact="'yes'"/>
				</do_if>
				<do_elseif value="event.param == 'BoardingSupport_Hack_Started_Conversation_no'">
					<set_value name="$hackoption" exact="'no'"/>
				</do_elseif>
				<do_elseif value="event.param == 'BoardingSupport_Hack_Started_Conversation_never'">
					<set_value name="$hackoption" exact="'never'"/>
				</do_elseif>
				<reset_cue cue="BoardingCycle"/>
			</actions>
		</cue>
		<cue name="BoardingSupport_Destroy_Options" instantiate="true">
			<conditions>
				<event_conversation_next_section sectionprefix="BoardingSupport_Destroy_Options_Conversation_"/>
			</conditions>
			<actions>
				<do_if value="event.param == 'BoardingSupport_Destroy_Options_Conversation_normalsupport'">
					<set_value name="$destroyoption" exact="'normal'"/>
				</do_if>
				<do_elseif value="event.param == 'BoardingSupport_Destroy_Options_Conversation_weaponsonly'">
					<set_value name="$destroyoption" exact="'weaponsonly'"/>
				</do_elseif>
				<do_elseif value="event.param == 'BoardingSupport_Destroy_Options_Conversation_hackingonly'">
					<set_value name="$destroyoption" exact="'hackingonly'"/>
					<set_value name="$hackoption" exact="'always'"/>
				</do_elseif>
				<reset_cue cue="BoardingCycle"/>
			</actions>
		</cue>
	</add>

	<add sel="//cue[@name='BeginBoardingCycle']/actions">
		<set_value name="$checkattackstrength" exact="true"/>
	</add>

	<add sel="//cue[@name='BoardingCycle']/actions" pos="prepend">
		<do_all exact="player.primaryship.drones.count" counter="$i">
			<do_if value="player.primaryship.drones.{$i}.hackerprobe">
				<set_value name="$hackerdroneexists" exact="true"/>
			</do_if>
		</do_all>
	</add>

	<add sel="//cue[@name='BoardingCycle']/actions/do_if[@value='$missiontype == 3']" pos="before">
		<do_if value="$destroyoption == 'undecided'">
			<start_conversation actor="player.copilot" conversation="BoardingSupport_Destroy_Options_Conversation"/>
			<set_value name="$missiontype" exact="99"/>
		</do_if>
		<do_elseif value="$destroyoption == 'weaponsonly'">
			<set_value name="$missiontype" exact="3"/>
		</do_elseif>
		<do_elseif value="$hackoption == 'always' and $hackerdroneexists">
			<set_value name="$missiontype" exact="2"/>
		</do_elseif>
		<do_elseif value="$hackoption == 'yes' and $hackerdroneexists">
			<set_value name="$missiontype" exact="2"/>
			<set_value name="$hackoption" exact="'undecided'"/>
		</do_elseif>
		<do_elseif value="$hackoption == 'no'">
			<set_value name="$missiontype" exact="3"/>
			<set_value name="$hackoption" exact="'undecided'"/>
		</do_elseif>
		<do_elseif value="$hackoption == 'never'">
			<do_any>
				<set_value name="$missiontype" exact="1" comment="skip (treat as success)" weight="1"/>
				<set_value name="$missiontype" exact="3" comment="Destroy surface element" weight="80"/>
			</do_any>
		</do_elseif>
		<do_elseif value="$missiontype == 2 and $hackoption == 'undecided' and $hackerdroneexists">
			<remove_help all="true"/>
			<set_value name="$checkresistance" exact="false"/>
			<signal_cue cue="ResetCheckResistance"/>
			<start_conversation actor="player.copilot" conversation="BoardingSupport_Hack_Started_Conversation"/>
			<set_value name="$missiontype" exact="99"/>
		</do_elseif>
	</add>

	<add sel="//cue[@name='BoardingCycle']/actions/do_if[@value='$missiontype == 3']/find_object_component[@name='$surfaceelem']" pos="after">
		<do_if value="$destroyoption == 'weaponsonly'">
			<find_object_component name="$surfaceelem" object="$target" class="class.weapon" surfaceelement="true" integrated="false"/>
		</do_if>
	</add>

	<remove sel="//cue[@name='SupportMission_Hack']/actions/start_conversation"/>

	<add sel="//cue[@name='SupportMissionDone']/actions" pos="prepend">
		<cancel_conversation actor="player.copilot" conversation="BoardingSupport_Hack_Started_Conversation"/>
		<cancel_conversation actor="player.copilot" conversation="BoardingSupport_Destroy_Options_Conversation"/>
	</add>

	<add sel="//library[@name='ClearOnFail']/actions">
		<remove_value name="$PreboardUnits"/>
		<remove_help all="true"/>
		<set_value name="$checkresistance" exact="false"/>
	</add>
	<add sel="//cue[@name='Finish']/actions" pos="prepend">
		<remove_help all="true"/>
		<set_value name="$checkresistance" exact="false"/>
	</add>
</diff>